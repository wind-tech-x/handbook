---
sidebar_position: 2
---

# コードレビューで見るべきこと
以下を読む前に、必ず「[コードレビュー標準](./standard-of-review)」を念頭に置くこと。

## まとめ
コードレビューにおいて、次の点を必ず確認すること。

* コードの設計が適切である
* 機能がコードの利用者にとって有用である
* コードが必要以上に複雑になっていない
* 将来必要かもしれないが現時点で確実ではない機能を実装していない
* テストの設計が適切である
* すべてにおいて明確な名前が使われている
* コメントが明確で有用であり、主に「なぜ」を説明している
* コードが適切にドキュメント化されている
* コードがスタイルガイドに準拠している

レビュー対象として依頼されたコードはすべての行を確認しよう！

コンテキストを考慮し、コードの健全性を向上させるようにしよう！

良い点があれば開発者を褒めよう！

## 設計
コードレビューで最も重要な点は、コード変更(CL: Change List)の全体的な設計である。
* CL内のさまざまなコードがどのように連携しているか？
* CLはコードベースに含めるべきか？
* CLはライブラリに含めるべきか？
* システム全体とうまく統合されているか？
* この機能をいま追加するのが適切なタイミングか？

## 機能
* CLは、開発者の意図どおりの動作しているか？
* 開発者の意図は、このコードの利用者にとって良いものになっているか？

「利用者」とは、エンドユーザー（この変更の影響を受ける場合）と、将来的にこのコードを利用する開発者の両方を指す。

通常、開発者はCLがコードレビューに回ってくる頃には、十分にテストして正しく動作する状態にしていることが期待される。
一方で、レビュアーとしては、明らかなバグがないか確認する必要がある。

UIの変更のようにコードを読むだけではどのような影響があるのか把握しにくい変更がある。
このようなとき、次のような手段で、CLを検証してみる。
* CLを自分の環境にパッチして動作させてみる
* 開発者にデモをしてもらう

並行プログラミングにかかわる変更が含まれているときは、デッドロックや競合状態が起こりうるかどうかを慎重に検討する必要がある。
この種の問題は実際にコードを実行しても簡単には見浸からないことが多い。
開発者とレビュアーの両方が注意深く考えないと、不具合を埋め込む可能性があります。

## 複雑さ
* CLは**過度に複雑**になっていないか？ 

CLをあらゆるレベル（行、関数、クラス）で確認する。

「過度に複雑」とは、コードを読む人がすぐに理解できない場合を指す。
または、将来的に誰かがこのコードを呼び出したり修正しようとしたときにバグが入りやすい状態も含む。

レビュアーが特に警戒する必要があるのは「**オーバーエンジニアリング**」である。

「オーバーエンジニアリング」とは、必要以上にコードが汎用的に作られていたり、現時点では必要のない機能を追加している状態である。
レビュアーは、確実に現在必要とされる問題を解決するよう、開発者に促す。
将来必要になるかもしれない問題は、そのタイミングになって実際にわかる要件を踏まえて解決すればよい。

## テスト
CLが扱う変更内容に応じて、テストが適切に追加されているか確認する。

* ユニットテスト
* 統合テスト
* エンドツーエンド
* ...等

基本的には、テストは本番コードと同じCLで追加する必要がある（[緊急時のCL](./emergencies)は除く）。

CLに含まれるテストが正しく、妥当で、有用であることを確認する。
テストはそれ自体をテストしませんし、私たちは通常テストに対するテストを書きません。
そのため、人間がテストを妥当と判断しなければなりません。

* コードが壊れたときに、そのテストは実際に失敗するか？
* コードが内部的に変更されたときに、誤った「成功」を返してしまう可能性はないか？
* 各テストはシンプルで、有用なアサーションを行っているか？
* 異なるテストメソッドに分割すべき部分がごちゃ混ぜになっていないか？

テストもメンテナンスの必要があるコードである。
テストだからといって複雑さを見逃すべきではない。

## 名前
* 開発者は適切な名前を付けているか？

「適切な名前」とは、次の条件を指す。

* それが何を表しているか分かること
* 何をするのかを十分に伝えられていること
* 十分な長さであること
* 長すぎて読みづらくならないこと

## コメント
* 開発者が書いたコメントは明快で理解しやすい英語、または日本語であるか？
* そのコメントは本当に必要なものか？

コメントは、**なぜそのコードが存在するのかを説明する**のに役立ちます。

一方、「何をしているのか」はコード自体がわかりやすく書かれていれば不要である。
もしコードだけでは十分に意図が伝わらない場合、コードをよりシンプルにすべきかもしれない。

また、今回のCLで変更されていない以前からあるコメントにも注目しよう。
もしかすると、今回の変更で「TODO」が不要になったり、過去のコメントで「この変更はしないでください」と書いてあるかもしれない。

:::note

正規表現や複雑なアルゴリズムのように、コードが何をしているのかをコメントで補足すると理解が大いに助かるケースもある。
しかし、ほとんどの場合、コメントはコード自体が示せない情報（たとえば、ある決定に至った理由）を伝えるためのものである。

:::

## ドキュメント
* CLがビルド方法、テスト方法、リリース方法などを変更する場合は、関連するドキュメント（README、生成されるリファレンスドキュメントなど）も更新されているか
* もしCLがコードを削除・非推奨化するなら、ドキュメントも削除すべきか検討する。
* ドキュメントが不足していれば、追記を依頼する。

:::warning

コメントは、クラス、モジュール、あるいは関数のドキュメントとは異なるものである。
ドキュメントは、そのコードの目的や使い方、利用時の振る舞いを説明するためのものであり、コメントとドキュメントは異なるものである。

:::

## スタイル
* CLが適切に[スタイルガイド](../coding-guidelines/style-guide)に準拠しているか確認すること。

スタイルガイドには載っていないスタイル上の改善点を提案したい場合は、コメントの先頭に「[Nit:](./review-comment)」と付けて、その指摘は必須ではなく「個人的にはこうしたほうがより良いと思う」という程度の提案であることを示すようにする。
個人的なスタイルの好みだけでCLの提出をブロックするのはやめる。

開発者は、主要なスタイル変更と機能的な変更を同じCLにまとめないようにする。
そうすると差分が見づらくなり、マージやロールバックにも問題が生じやすくなる。
たとえば、ファイル全体のフォーマットを変更したい場合は、そのリフォーマットだけを行うCLを先に出してもらい、その後で機能的変更を行うCLを出してもらうとよい。

### 一貫性
* 既存のコードが[スタイルガイド](../coding-guidelines/style-guide)と矛盾している場合はどうするべきか？

コードレビューの原則により、スタイルガイドは絶対的な基準である。
スタイルガイドで必須とされている内容であれば、それに従うようCLを修正する必要がある。

一方で、スタイルガイドが推奨にとどまっている場合は、ガイドの推奨に合わせるか、周囲のコードとの一貫性を保つかを判断する。
よほど周辺コードとの不一致が混乱を招く場合を除き、スタイルガイドに合わせることを優先する。

もし他のルールが適用できないなら、既存のコードとの一貫性を保つ。
いずれにせよ、既存コードのクリーンアップ（バグ登録や TODO の追加など）を促すとよい。

## すべての行を確認する
* 基本的に、レビューを依頼されたコードはすべて確認する。

データファイルや自動生成されたコード、大きなデータ構造などはざっと目を通すだけでも構わないが、人間が書いたクラスや関数、コードブロックは、中身をしっかり理解して問題がないか確認する。
どのコードをより綿密に確認するかは、レビュアーの判断に委ねられる。
ただし、少なくとも読み飛ばしたコードが何をしているのか把握はするべきである。

もしコードが複雑すぎて読むのが困難であり、レビューの妨げになっているなら、開発者にそれを伝えて、改善や説明を待ってからレビューを進めるべき。
我々のチームのエンジニアは優秀であり、あなたもその一人である。
あなたが理解できないコードは、他の開発者も理解に苦しむ可能性が高い。
したがって、開発者に明瞭化を求めることは将来的に開発者のためにもなる。

コードの内容を理解はできても、あなた自身がある特定の分野のレビューに自信がない場合は、
複雑な問題（プライバシー、セキュリティ、並行処理、アクセシビリティ、国際化等）を別のレビュアーが確認できるようにレビュアーの確保を行う。

### 例外
* 状況によっては、すべての行をレビューする必要がない場合がある。

たとえば、以下のようなケースである。

* もっと大きな変更の一部として特定のファイルのみレビューを依頼されている。
* 高レベルな設計やプライバシー、セキュリティへの影響など、CLの特定の側面だけをレビューしてほしいと依頼されている。

このような場合は、コメントで「どの部分をレビューしたか」を明記し、レビューした範囲に対して LGTM（Looks Good To Me）を出す。

もし他のレビュアーが別の部分をレビューすることを前提にLGTMを出すなら、その旨をコメントに明記し、期待値を共有する。
CLが望ましい状態になり次第、迅速にレビューを完了するように心がける。

## 広い範囲で検討する
* CLをより広い範囲で考察するのも有用である。

レビュー用のツールは、通常は変更された部分の前後数行だけを表示する。
しかし、ファイル全体を見ないと、この変更が本当に理にかなっているかどうか判断できない場合がある。
たとえば、4行追加されたように見えても、実はそれが 50 行におよぶ関数の中に追加されており、関数を分割するタイミングに来ているかもしれない。

また、システム全体の範囲の中でCLを検討することも重要である。
* システムのコード健全性を高める変更になっているか？
* 逆に、システム全体をより複雑にしたり、テスト不足にしたりしていないか？

システムの健全性を損ねるようなCLは受け入れてはいけない。
多くのシステムは小さな変更の積み重ねで複雑になっていくので、新たに加わる変更の小さな複雑さにも気をつける必要がある。

## 良い点
CLに良い点があったら、開発者に伝えよう！
特に、以前指摘したコメントをうまく対処してくれた場合などに感謝の意を示そう。
コードレビューはミスの指摘ばかりになりがちだが、優れたプラクティスについて褒めたり、奨励したりすることも大切である。
開発者にとっては、何が間違っているかを指摘されるよりも、どこが良いのかを教えてもらうほうが、学びやモチベーションに繋がることがよくある。
